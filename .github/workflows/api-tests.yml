name: API Automation Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'regression'
        type: choice
        options:
          - smoke
          - regression
          - all

jobs:
  api-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [17]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run Smoke Tests
        if: github.event.inputs.test_suite == 'smoke' || (github.event_name != 'workflow_dispatch')
        run: mvn clean test -DsuiteXmlFile=testng-smoke.xml -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Run Regression Tests
        if: github.event.inputs.test_suite == 'regression'
        run: mvn clean test -DsuiteXmlFile=testng-regression.xml -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Run All Tests
        if: github.event.inputs.test_suite == 'all'
        run: mvn clean test -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Generate Allure Report
        if: always()
        run: mvn allure:report
        continue-on-error: true

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-java-${{ matrix.java-version }}
          path: target/allure-results/
          retention-days: 30

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-java-${{ matrix.java-version }}
          path: target/site/allure-maven-plugin/
          retention-days: 30

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-java-${{ matrix.java-version }}
          path: target/logs/
          retention-days: 7

      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-java-${{ matrix.java-version }}
          path: target/surefire-reports/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          if [ -d target/surefire-reports ] && [ "$(ls -A target/surefire-reports)" ]; then
            echo "âœ… Test results generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“Š Check Allure reports in artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
            if [ -f target/surefire-reports/testng-results.xml ]; then
              echo "ğŸ“‹ TestNG results file found" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f target/surefire-reports/testng-failed.xml ]; then
              echo "âš ï¸ Some tests failed - check reports for details" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ No test results found" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” Check logs for compilation or execution errors" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with Test Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = './target/surefire-reports';

            if (fs.existsSync(path) && fs.readdirSync(path).length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## API Test Results (Java ${{ matrix.java-version }})
                
                âœ… Tests completed! Check the artifacts for detailed reports.
                
                ğŸ“Š **Allure Report**: Available in artifacts
                ğŸ“‹ **Surefire Reports**: Available in artifacts
                ğŸ“ **Test Logs**: Available in artifacts
                `
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## API Test Results (Java ${{ matrix.java-version }})
                
                âŒ Tests failed to execute properly. Check the workflow logs for details.
                `
              });
            }

  deploy-reports:
    needs: api-tests
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Allure Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report-java-17
          path: ./allure-report
        continue-on-error: true

      - name: Deploy to GitHub Pages
        if: hashFiles('./allure-report/**') != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: reports
